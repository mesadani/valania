{% extends 'base.html' %}
{% load static %}
{% block content %}
<div id="loading-overlay">
    <div id="loading-spinner"></div>
</div>
<h1 style="text-align: center; color: #2c3e50;"></h1>

<div id="status" style="text-align: center; margin-bottom: 20px;">
    {% if user.is_authenticated %}
        <p><strong>{{ user.username }}</strong></p>
        <form action="{% url 'logout' %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn">Cerrar sesión</button>
        </form>
    {% else %}
        <button class="btn" onclick="connectAndLogin()">Login with Phantom</button>
    {% endif %}
</div>

{% if user.is_authenticated %}
<div class="tabs-container">
    <button class="tab-button active" onclick="openTab(event, 'orders')">Orders</button>
    <button class="tab-button" onclick="openTab(event, 'tab2')">Inventory</button>
    <button class="tab-button" onclick="openTab(event, 'tab3')">Guild</button>
</div>

<div id="orders" class="tab-content" style="display: block;">
    <h3 style="color: #34495e;">Orders</h3>
    <table class="styled-table">
        <thead>
            <tr>
                <th>Object</th>
                <th>Price</th>
                <th>Created Date</th>
                <th>Availabilable</th>
                <th>Date Finalized</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for notification in notifications %}
            <td>
                <img src="{{ notification.object.image.url }}" alt="{{ notification.object.name }}" style="width: 40px; height: 40px; margin-right: 10px; vertical-align: middle;">
                {{ notification.object.name }}
            </td>
            <td>{{ notification.price }}</td>
            <td>{{ notification.created_at }}</td>
            <td>{{ notification.available|yesno:"Sí,No" }}</td>
            <td>{{ notification.updated_at }}</td>
            <td>
                <button class="icon-button" onclick="deleteNotification('{{ notification.id }}')">
                    <img src="{% static 'icons/delete-icon.png' %}" alt="Eliminar" style="width: 20px; height: 20px;">
                </button>
            </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <form id="orderForm" style="margin-top: 20px;">
        <label for="objectSelect">Selecciona un objeto:</label>
        <select id="objectSelect" name="object">
            {% for object in objects %}
            <option value="{{ object.id }}">{{ object.name }}</option>
            {% endfor %}
        </select>

        <label for="priceInput">Precio:</label>
        <input type="number" id="priceInput" name="price" step="0.01" required>

        <button type="button" class="btn" onclick="saveOrder()">Guardar</button>
    </form>
</div>
<div id="tab2" class="tab-content">
    <p></p>
</div>
<div id="tab3" class="tab-content">
    <p></p>
</div>
{% endif %}

<style>
    
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: none; /* Ocultar por defecto */
        z-index: 9999; /* Asegura que cubra toda la pantalla */
        justify-content: center;
        align-items: center;
    }

    #loading-spinner {
        border: 10px solid #f3f3f3;
        border-top: 10px solid gold;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    /* Animación del spinner */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    body {
        font-family: 'Arial', sans-serif;
        background-color: #ecf0f1;
        color: #2c3e50;
    }
    .btn {
        background-color: #2980b9;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .btn:hover {
        background-color: #1abc9c;
    }
    .tabs-container {
        margin-top: 20px;
        text-align: center;
    }
    .tab-button {
        background-color: #2980b9;
        color: white;
        padding: 10px 15px;
        margin-right: 5px;
        cursor: pointer;
        border-radius: 5px;
        border: none;
        transition: background-color 0.3s;
    }
    .tab-button.active {
        background-color: #1abc9c;
    }
    .tab-content {
        display: none;
        padding: 15px;
        margin-top: 10px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .styled-table {
        width: 100%;
        border-collapse: collapse;
        margin: 25px 0;
        font-size: 0.9em;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    .styled-table thead tr {
        background-color: #2980b9;
        color: #ffffff;
        text-align: left;
    }
    .styled-table th, .styled-table td {
        padding: 12px 15px;
    }
    .styled-table tbody tr {
        border-bottom: 1px solid #dddddd;
    }
    .styled-table tbody tr:nth-of-type(even) {
        background-color: #f3f3f3;
    }
    .styled-table tbody tr:last-of-type {
        border-bottom: 2px solid #2980b9;
    }
    .icon-button {
        background: none;
        border: none;
        cursor: pointer;
    }
</style>

<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

<script>
function deleteNotification(notificationId) {
    document.getElementById('loading-overlay').style.display = 'flex';
    fetch(`/delete_order/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'  // Asegúrate de que el token CSRF esté disponible
        },
        body: JSON.stringify({
            idNotification: notificationId,

        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status = 'ok') {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("Notification deleted successfully.");
            location.reload(); // Recargar la página para actualizar la lista de notificaciones
        } else {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("An error occurred while deleting the notification: " + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loading-overlay').style.display = 'none';
        console.error("Error en la solicitud AJAX:", error);
        alert("An error occurred while deleting the notification.");
    });
}
function saveOrder() {
    const objectId = document.getElementById('objectSelect').value;
    const price = document.getElementById('priceInput').value;

    if (!objectId || !price) {
        alert("Please fill in all the fields.");
        return;
    }
    document.getElementById('loading-overlay').style.display = 'flex';
    fetch('/save-order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'  // Asegúrate de que el token CSRF esté disponible
        },
        body: JSON.stringify({
            object_id: objectId,
            price: price
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status = 'ok') {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("Order saved successfully.");
            location.reload();
        } else {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("Error saving the order: " + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loading-overlay').style.display = 'none';
        alert("An error occurred while saving the order.");
    });
}
function openTab(evt, tabName) {
    var i, tabcontent, tabbuttons;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tabbuttons = document.getElementsByClassName("tab-button");
    for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}
async function connectAndLogin() {
    const provider = window.solana;

    if (!provider || !provider.isPhantom) {
        alert("Please install Phantom Wallet: https://phantom.app/");
        return;
    }

    try {
        // Conectar con Phantom
        const connectResponse = await provider.connect();
        const publicKey = connectResponse.publicKey.toString();
      

        // Obtener nonce del servidor
        const nonceRes = await fetch("/get-nonce/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ public_key: publicKey })
        });
        const { nonce } = await nonceRes.json();

        // Firmar el nonce
        const encodedMessage = new TextEncoder().encode(nonce);
        const signedMessage = await provider.signMessage(encodedMessage, "utf8");

        // Enviar firma al servidor
        const verifyRes = await fetch("/verify-login/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                public_key: publicKey,
                signature: Array.from(signedMessage.signature)
            })
        });

        const result = await verifyRes.json();
        if (result.success) {
            alert("Login exitoso");
            location.reload();
        } else {
            alert("Error: " + result.error);
        }
    } catch (err) {
      
        alert("An error occurred while authenticating with Phantom");
    }
}
</script>

{% endblock %}
